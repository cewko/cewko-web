<div class="widget-drag-handle">
  <div class="hangout-header">
    <div class="widget-title">HANGOUT</div>
    <div class="online-count">({{ online_count }} online)</div>
  </div>
</div>
<div class="widget-bar"></div>

<div class="chat-messages" id="chat-messages"></div>

<div class="chat-input-container">
  <textarea 
    class="chat-input" 
    placeholder="Enter your message..." 
    id="message-input"
    maxlength="280"></textarea>
  <div class="chat-bottom">
    <input 
      type="text" 
      class="nickname-input" 
      placeholder="Nickname (anonymous by default)" 
      id="nickname-input"
      maxlength="64">
    <button class="send-button" id="send-button">Send</button>
  </div>
</div>

<script>
  (function () {
    // Audio context for notification sounds
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;
    let hasInteracted = false;

    // Load sound preference from localStorage
    const savedPref = localStorage.getItem("hangout-sound-enabled");
    if (savedPref !== null) {
      soundEnabled = savedPref === "true";
    }

    function playNotificationSound() {
      if (!soundEnabled || !hasInteracted) return;

      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          600,
          audioContext.currentTime + 0.1
        );

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.2
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (e) {
        console.error("Failed to play sound:", e);
      }
    }

    // Enable audio context on first user interaction
    document.addEventListener(
      "click",
      () => {
        hasInteracted = true;
        if (audioContext.state === "suspended") {
          audioContext.resume();
        }
      },
      { once: true }
    );

    const ws = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host +
        "/ws/hangout/"
    );

    const messagesContainer = document.getElementById("chat-messages");
    const messageInput = document.getElementById("message-input");
    const nicknameInput = document.getElementById("nickname-input");
    const sendButton = document.getElementById("send-button");
    const onlineCountElement = document.querySelector(".online-count");

    let isInitialLoad = true;

    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      const timeString = date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
      });

      if (messageDate.getTime() === today.getTime()) {
        return timeString;
      } else if (messageDate.getTime() === yesterday.getTime()) {
        return `Yesterday | ${timeString}`;
      } else {
        const day = String(date.getDate()).padStart(2, '0');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        return `${day} ${month}. ${year} | ${timeString}`;
      }
    }

    function displayMessage(data, skipSound = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = "chat-message";

      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      timeDiv.textContent = `[ ${formatTimestamp(data.timestamp)} ]`;

      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";

      const authorSpan = document.createElement("div");
      authorSpan.className = "message-author";
      
      let authorText = data.nickname;
      if (data.is_highlighted) {
        authorText += " [ ! ]";
      }
      if (data.from_discord) {
        authorText += " [ Discord ]";
      }
      authorText += " : ";
      authorSpan.textContent = authorText;

      const textDiv = document.createElement("div");
      textDiv.className = "message-text";
      textDiv.textContent = data.content;

      contentDiv.appendChild(authorSpan);
      contentDiv.appendChild(textDiv);

      messageDiv.appendChild(timeDiv);
      messageDiv.appendChild(contentDiv);

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Play notification sound for new messages (not initial load)
      if (!skipSound && !isInitialLoad) {
        playNotificationSound();
      }
    }

    function showError(message) {
      console.error("Hangout error:", message);
      // Optionally show a subtle in-widget notification instead of alert
      // For now, just log to console
    }

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);

      if (data.type === "message") {
        displayMessage(data);
      } else if (data.type === "system") {
        if (data.message === "connected to hangout") {
          setTimeout(() => {
            isInitialLoad = false;
          }, 100);
        }
      } else if (data.type === "error") {
        showError(data.message);
      } else if (data.type === "online_count") {
        if (onlineCountElement) {
          onlineCountElement.textContent = `(${data.count} online)`;
        }
      }
    };

    // Heartbeat every 25 seconds
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(
          JSON.stringify({
            type: "heartbeat",
          })
        );
      }
    }, 25000);

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    ws.onclose = (event) => {
      console.log("WebSocket closed:", event.code, event.reason);
    };

    function sendMessage() {
      const content = messageInput.value.trim();
      if (!content) return;

      const nickname = nicknameInput.value.trim() || "anonymous";

      ws.send(
        JSON.stringify({
          type: "message",
          nickname: nickname,
          content: content,
        })
      );

      messageInput.value = "";
    }

    sendButton.addEventListener("click", sendMessage);

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  })();
</script>